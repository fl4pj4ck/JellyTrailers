<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JellyTrailers</title>
    <style>
        .trailers-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        .trailers-card h3 {
            margin: 0 0 1rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            letter-spacing: 0.02em;
        }
        .trailers-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
        }
        .trailers-stat-box {
            background: rgba(0,0,0,0.25);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .trailers-stat-box .label {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.55);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-bottom: 0.25rem;
        }
        .trailers-stat-box .value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #fff;
        }
        .trailers-stat-box.success .value { color: #4ade80; }
        .trailers-stat-box.warn .value { color: #fbbf24; }
        .trailers-stat-box.muted .value { color: rgba(255,255,255,0.7); }
        .trailers-last-run {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.08);
            font-size: 0.875rem;
            color: rgba(255,255,255,0.7);
        }
        .trailers-intro {
            color: rgba(255,255,255,0.75);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }
        .trailers-danger {
            border-color: rgba(239,68,68,0.3);
            background: rgba(239,68,68,0.06);
        }
        .trailers-danger h3 { color: #f87171; }
        .trailers-danger .fieldDescription { color: rgba(255,255,255,0.6); }
        .trailers-ytdlp-alert {
            background: rgba(185,28,28,0.25) !important;
            border: 2px solid #dc2626 !important;
            border-radius: 6px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.25rem;
            color: #fecaca !important;
            font-size: 0.9rem;
            line-height: 1.45;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2) inset;
        }
        .trailers-ytdlp-alert.hidden { display: none !important; }
        .trailers-ytdlp-alert-icon { color: #fca5a5 !important; font-size: 1.25rem; flex-shrink: 0; line-height: 1; }
        .trailers-ytdlp-alert-msg { flex: 1; min-width: 0; word-wrap: break-word; }
        .trailers-ytdlp-ok {
            background: rgba(34,197,94,0.12);
            border-left: 4px solid #22c55e;
            color: rgba(255,255,255,0.85);
            padding: 0.6rem 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            min-height: 1.5em;
            box-sizing: border-box;
        }
        .trailers-ytdlp-ok.hidden { display: none !important; }
        .trailers-notice {
            background: rgba(255,255,255,0.05) !important;
            border: 1px solid rgba(255,255,255,0.2) !important;
            border-left: 4px solid rgba(255,255,255,0.4) !important;
            border-radius: 8px !important;
            padding: 1rem 1.25rem !important;
            margin-bottom: 1rem !important;
            font-size: 0.9rem !important;
            line-height: 1.45 !important;
            color: rgba(255,255,255,0.9) !important;
            box-sizing: border-box !important;
            display: block !important;
        }
        .trailers-notice.hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="JellyTrailersConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="JellyTrailersConfigForm">
                    <div class="sectionTitleContainer flex align-items-center" style="flex-wrap: wrap; gap: 0.5rem;">
                        <h2 class="sectionTitle">JellyTrailers</h2>
                        <span id="JellyTrailersVersion" style="font-size: 0.875rem; font-weight: normal; color: rgba(255,255,255,0.55); align-self: center;"></span>
                    </div>
                    <p class="trailers-intro" style="color: rgba(255,255,255,0.75); font-size: 0.9rem; line-height: 1.5; margin-bottom: 1.5rem;">Download movie and TV show trailers with yt-dlp and place them next to your media. Run the scheduled task &quot;Download Trailers&quot; from Dashboard → Scheduled Tasks (set the schedule there).</p>

                    <div id="JellyTrailersYtDlpAlert" class="trailers-ytdlp-alert hidden" role="alert" style="display: none; background: #7f1d1d; border: 2px solid #dc2626; border-radius: 6px; padding: 1rem 1.25rem; margin-bottom: 1.25rem; color: #fecaca; font-size: 0.9rem; line-height: 1.45; flex-direction: row; align-items: flex-start; gap: 0.75rem; box-sizing: border-box;">
                        <span aria-hidden="true" style="color: #fca5a5; font-size: 1.25rem; flex-shrink: 0; line-height: 1;">⚠</span>
                        <div style="flex: 1; min-width: 0; word-wrap: break-word;">
                            <strong id="JellyTrailersYtDlpAlertTitle" style="display: block; margin-bottom: 0.25rem; color: #fca5a5;">yt-dlp not available</strong>
                            <span id="JellyTrailersYtDlpAlertMessage"></span>
                            <div style="margin-top: 0.75rem;">
                                <button type="button" id="BtnDownloadYtDlp" is="emby-button" class="raised button-submit emby-button">
                                    <span>Download yt-dlp</span>
                                </button>
                                <span id="JellyTrailersYtDlpDownloadStatus" style="margin-left: 0.5rem;"></span>
                            </div>
                        </div>
                    </div>
                    <div id="JellyTrailersYtDlpOk" class="trailers-ytdlp-ok hidden" style="display: none; padding: 0.65rem 1rem; margin-bottom: 1.5rem; line-height: 1.5; min-height: 1.5em; box-sizing: border-box;"></div>

                    <div class="trailers-card" id="JellyTrailersStatsCard" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1.25rem; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: rgba(255,255,255,0.9);">Statistics</h3>
                        <div id="JellyTrailersStatsContent">Loading stats…</div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.08); display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                            <p class="fieldDescription" style="margin: 0;">Clear downloaded/failed counts and run history.</p>
                            <button type="button" id="BtnResetStats" is="emby-button" class="emby-button" style="padding: 0.35rem 0.75rem; font-size: 0.875rem; background: #fbbf24; color: #000;">Reset statistics</button>
                        </div>
                    </div>

                    <div class="trailers-card" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1.25rem; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: rgba(255,255,255,0.9);">Library selection</h3>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="IncludeLibraryNames">Include only these libraries</label>
                            <input id="IncludeLibraryNames" name="IncludeLibraryNames" type="text" is="emby-input" placeholder="(empty = all)" />
                            <div class="fieldDescription">Comma-separated library names to include (e.g. Movies, TV Shows). Leave empty to use all movie/TV libraries.</div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="ExcludeLibraryNames">Exclude these libraries</label>
                            <input id="ExcludeLibraryNames" name="ExcludeLibraryNames" type="text" is="emby-input" placeholder="(none)" />
                            <div class="fieldDescription">Comma-separated library names to exclude from trailer download and remove-all.</div>
                        </div>
                    </div>

                    <div class="trailers-card" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1.25rem; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: rgba(255,255,255,0.9);">Download settings</h3>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="YtDlpPath">yt-dlp path</label>
                        <input id="YtDlpPath" name="YtDlpPath" type="text" is="emby-input" placeholder="(auto-download)" />
                        <div class="fieldDescription">Leave empty to use the plugin-managed copy (downloaded automatically). Set a path to use your own yt-dlp (e.g. /usr/local/bin/yt-dlp or yt-dlp). On Docker/official image you may need to install yt-dlp inside the container or use the plugin-managed copy (leave empty).</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="TrailerPath">Trailer filename</label>
                        <input id="TrailerPath" name="TrailerPath" type="text" is="emby-input" />
                        <div class="fieldDescription">Filename relative to each media folder (e.g. trailer.mp4).</div>
                    </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="Quality">Max quality</label>
                        <select is="emby-select" id="Quality" name="Quality" class="emby-select-withcolor emby-select">
                            <option value="best">Best</option>
                            <option value="1080p">1080p</option>
                            <option value="720p">720p</option>
                            <option value="480p">480p</option>
                        </select>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="DelaySeconds">Delay between downloads (seconds)</label>
                        <input id="DelaySeconds" name="DelaySeconds" type="number" is="emby-input" min="0" />
                        <div class="fieldDescription">Seconds to wait between each download (reduces throttling).</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="RetryDelaySeconds">Retry delay (seconds)</label>
                        <input id="RetryDelaySeconds" name="RetryDelaySeconds" type="number" is="emby-input" min="0" />
                        <div class="fieldDescription">Seconds to wait before retrying a failed download.</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="MaxTrailersPerRun">Max trailers per run</label>
                        <input id="MaxTrailersPerRun" name="MaxTrailersPerRun" type="number" is="emby-input" min="0" />
                        <div class="fieldDescription">Maximum trailers per scheduled run (0 = no limit).</div>
                    </div>
                    <div class="checkboxContainer checkboxContainer-withDescription" style="margin-bottom: 1rem;">
                        <label class="emby-checkbox-label">
                            <input id="UseTmdbOmdbFallback" name="UseTmdbOmdbFallback" type="checkbox" is="emby-checkbox" />
                            <span>Use TMDB/OMDb fallback when YouTube fails</span>
                        </label>
                        <div class="fieldDescription">If download from YouTube fails, try the first trailer URL from Jellyfin metadata (TMDB/OMDb).</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="YtDlpOptionsJson">Extra yt-dlp options (JSON)</label>
                        <input id="YtDlpOptionsJson" name="YtDlpOptionsJson" type="text" is="emby-input" />
                        <div id="JellyTrailersYtDlpJsonError" class="fieldDescription" style="color: #f87171; margin-top: 0.25rem; display: none;"></div>
                        <div class="fieldDescription">Optional JSON object. Only allowlisted options are applied (e.g. user-agent, proxy, format); exec and similar are ignored.</div>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                    </div>

                    <div class="trailers-card trailers-danger" style="border: 1px solid rgba(239,68,68,0.3); background: rgba(239,68,68,0.06); border-radius: 8px; padding: 1.25rem; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: #f87171;">Remove all trailers</h3>
                        <p class="fieldDescription" style="margin-bottom: 1rem;">Delete every trailer file from movie and TV library folders. Uses the &quot;Trailer filename&quot; setting above. A library scan will run after removal.</p>
                        <button type="button" id="BtnRemoveAllTrailers" is="emby-button" class="raised button-cancel block emby-button">
                            <span>Remove all trailers</span>
                        </button>
                        <div id="RemoveAllTrailersStatus" class="fieldDescription" style="margin-top: 0.5em;"></div>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            (function() {
                // Set from server (Plugins/JellyTrailers/Version) so config page never gets out of sync with PluginConstants.PluginId
                var pluginId = '';
                var page = document.querySelector('#JellyTrailersConfigPage');
                var form = document.querySelector('#JellyTrailersConfigForm');
                var lastYtDlpVersion = '';

                function formatDate(iso) {
                    if (!iso) return '—';
                    try {
                        var d = new Date(iso);
                        return isNaN(d.getTime()) ? iso : d.toLocaleDateString() + ' ' + d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                    } catch (e) { return iso; }
                }

                function renderStats(stats, scheduleInfo) {
                    var el = document.querySelector('#JellyTrailersStatsContent');
                    var hasFolderStats = stats && (stats.totalFolders || 0) > 0;
                    var hasRunStats = stats && (stats.totalDownloaded > 0 || stats.totalFailed > 0 || stats.lastRunDate);
                    if (!stats || (!hasFolderStats && !hasRunStats)) {
                        var scheduleLine = scheduleInfo ? '<p style="margin: 0.75rem 0 0 0; font-size: 0.875rem; color: rgba(255,255,255,0.7);">' + scheduleInfo + '</p>' : '';
                        el.innerHTML = '<p style="color: rgba(255,255,255,0.5); margin: 0;">No stats yet. Run the &quot;Download Trailers&quot; task once (Dashboard → Scheduled Tasks) to see folder and download stats.</p>' + scheduleLine;
                        return;
                    }
                    var totalD = stats.totalDownloaded || 0;
                    var totalF = stats.totalFailed || 0;
                    var d7 = stats.last7Days || 0;
                    var d30 = stats.last30Days || 0;
                    var runs = stats.totalRuns != null ? stats.totalRuns : 0;
                    var totalFolders = stats.totalFolders || 0;
                    var withTrailer = stats.foldersWithTrailer || 0;
                    var missing = totalFolders - withTrailer;
                    var pct = totalFolders > 0 ? Math.round((withTrailer / totalFolders) * 100) : 0;
                    var gridStyle = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem;';
                    var boxStyle = 'background: rgba(0,0,0,0.25); border-radius: 6px; padding: 0.75rem 1rem; text-align: center; border: 1px solid rgba(255,255,255,0.06);';
                    var labelStyle = 'font-size: 0.75rem; color: rgba(255,255,255,0.55); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.25rem;';
                    var valueGreen = 'font-size: 1.25rem; font-weight: 600; color: #4ade80;';
                    var valueWarn = 'font-size: 1.25rem; font-weight: 600; color: #fbbf24;';
                    var valueMuted = 'font-size: 1.25rem; font-weight: 600; color: rgba(255,255,255,0.7);';
                    var html = '';
                    if (hasFolderStats) {
                        html += '<div style="margin-bottom: 1rem; padding: 0.75rem 1rem; background: rgba(0,0,0,0.2); border-radius: 6px; border: 1px solid rgba(255,255,255,0.08); font-size: 0.9rem; color: rgba(255,255,255,0.85);">' +
                            '<span style="font-weight: 600;">Folders with trailer:</span> ' + withTrailer + ' / ' + totalFolders + ' <span style="color: rgba(255,255,255,0.6);">(' + pct + '%)</span>' +
                            (missing > 0 ? ' · <span style="color: #fbbf24;">Missing: ' + missing + '</span>' : ' · <span style="color: #4ade80;">All have trailer</span>') +
                            '</div>';
                    }
                    html += '<div style="' + gridStyle + '">' +
                        '<div style="' + boxStyle + '"><div style="' + labelStyle + '">Total downloaded</div><div style="' + valueGreen + '">' + totalD + '</div></div>' +
                        '<div style="' + boxStyle + '"><div style="' + labelStyle + '">Last 7 days</div><div style="' + valueGreen + '">' + d7 + '</div></div>' +
                        '<div style="' + boxStyle + '"><div style="' + labelStyle + '">Last 30 days</div><div style="' + valueGreen + '">' + d30 + '</div></div>' +
                        '<div style="' + boxStyle + '"><div style="' + labelStyle + '">Failed (total)</div><div style="' + valueWarn + '">' + totalF + '</div></div>' +
                        '<div style="' + boxStyle + '"><div style="' + labelStyle + '">Task runs</div><div style="' + valueMuted + '">' + runs + '</div></div>' +
                        '</div>';
                    var footerParts = [];
                    if (scheduleInfo) {
                        footerParts.push('<span style="margin-right: 1rem;">Schedule: ' + scheduleInfo + '</span>');
                    }
                    if (stats.lastRunDate) {
                        footerParts.push('<span>Last run: ' + formatDate(stats.lastRunDate) + ' — <strong>' + (stats.lastRunDownloaded || 0) + '</strong> downloaded, <strong>' + (stats.lastRunFailed || 0) + '</strong> failed</span>');
                    }
                    if (footerParts.length > 0) {
                        var ytDlpVer = (typeof lastYtDlpVersion !== 'undefined' && lastYtDlpVersion) ? ('yt-dlp: ' + lastYtDlpVersion) : '';
                        html += '<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.08); font-size: 0.875rem; color: rgba(255,255,255,0.7); display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap;">' +
                            '<div style="display: flex; flex-direction: column; gap: 0.25rem;">' + footerParts.join('') + '</div>' +
                            '<span id="JellyTrailersStatsYtDlpVersion" style="flex-shrink: 0;">' + (ytDlpVer || '') + '</span></div>';
                    }
                    el.innerHTML = html;
                }

                function getScheduleInfo(task) {
                    if (!task) return null;
                    var raw = task.Triggers || task.TriggerInfo;
                    var triggers = Array.isArray(raw) ? raw : (raw != null ? [raw] : []);
                    var triggerWithTime = triggers.find(function(t) { return t != null && (t.TimeOfDayTicks != null || t.TimeOfDayTicks === 0); });
                    if (!triggerWithTime) return 'Not set (run manually from Dashboard → Scheduled Tasks)';
                    var ticks = triggerWithTime.TimeOfDayTicks;
                    var sec = Math.floor(Number(ticks) / 1e7);
                    var h = Math.floor(sec / 3600) % 24;
                    var m = Math.floor((sec % 3600) / 60);
                    var timeStr = (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
                    return 'Daily at ' + timeStr + ' (server time)';
                }

                function refreshStats() {
                    var url = ApiClient.getUrl('Plugins/JellyTrailers/Stats') + '?t=' + Date.now();
                    var statsPromise = ApiClient.getJSON(url);
                    var tasksPromise = ApiClient.getJSON(ApiClient.getUrl('ScheduledTasks')).catch(function() { return []; });
                    Promise.all([statsPromise, tasksPromise]).then(function(results) {
                        var stats = results[0];
                        var tasks = results[1] || [];
                        var task = tasks.find(function(t) { return t.Key === 'JellyTrailersDownload'; });
                        var scheduleInfo = getScheduleInfo(task);
                        renderStats(stats, scheduleInfo);
                    }).catch(function() {
                        document.querySelector('#JellyTrailersStatsContent').textContent = 'Stats unavailable.';
                    });
                }

                function refreshYtDlpCheck() {
                    var alertEl = document.getElementById('JellyTrailersYtDlpAlert');
                    var okEl = document.getElementById('JellyTrailersYtDlpOk');
                    var titleEl = document.getElementById('JellyTrailersYtDlpAlertTitle');
                    var msgEl = document.getElementById('JellyTrailersYtDlpAlertMessage');
                    function showAlert(title, msg) {
                        okEl.style.display = 'none';
                        okEl.classList.add('hidden');
                        lastYtDlpVersion = '';
                        var verSpan = document.getElementById('JellyTrailersStatsYtDlpVersion');
                        if (verSpan) verSpan.textContent = '';
                        titleEl.textContent = title;
                        msgEl.textContent = msg;
                        document.getElementById('JellyTrailersYtDlpDownloadStatus').textContent = '';
                        alertEl.style.display = 'flex';
                        alertEl.classList.remove('hidden');
                    }
                    function hideAlert() {
                        alertEl.style.display = 'none';
                        alertEl.classList.add('hidden');
                        okEl.style.display = 'none';
                        okEl.classList.add('hidden');
                    }
                    ApiClient.getJSON(ApiClient.getUrl('Plugins/JellyTrailers/YtDlpCheck') + '?t=' + Date.now()).then(function(r) {
                        if (r.Available) {
                            hideAlert();
                            lastYtDlpVersion = r.Message || '';
                            var verSpan = document.getElementById('JellyTrailersStatsYtDlpVersion');
                            if (verSpan) {
                                verSpan.textContent = lastYtDlpVersion ? ('yt-dlp: ' + lastYtDlpVersion) : '';
                            } else {
                                okEl.style.display = 'block';
                                okEl.classList.remove('hidden');
                                okEl.textContent = lastYtDlpVersion ? ('yt-dlp: ' + lastYtDlpVersion) : 'yt-dlp is available.';
                            }
                        } else {
                            showAlert('yt-dlp not available', r.Message || 'Set the full path below or install it where Jellyfin runs.');
                        }
                    }).catch(function() {
                        showAlert('Could not check yt-dlp', 'Check failed. Set the path below if you have installed it.');
                    });
                }

                var statsPollInterval;

                function loadVersionAndConfig() {
                    return ApiClient.getJSON(ApiClient.getUrl('Plugins/JellyTrailers/Version') + '?t=' + Date.now()).then(function(r) {
                        if (r && r.PluginId) pluginId = r.PluginId;
                        var el = document.getElementById('JellyTrailersVersion');
                        if (el && r && r.Version) el.textContent = 'Version ' + r.Version;
                        if (!pluginId) return Promise.reject(new Error('Plugin ID not available'));
                        return ApiClient.getPluginConfiguration(pluginId).then(function(config) {
                            var didNormalizePath = false;
                            var didNormalizeJson = false;
                            var pathCorrected = config.TrailerPathCorrected === true || config.trailerPathCorrected === true;
                            var path = config.TrailerPath || config.trailerPath;
                            var jsonStr = config.YtDlpOptionsJson || config.ytDlpOptionsJson;
                            if (isInvalidTrailerPath(path) || pathCorrected) {
                                config.TrailerPath = config.trailerPath = 'trailer.mp4';
                                config.TrailerPathCorrected = config.trailerPathCorrected = false;
                                didNormalizePath = true;
                            }
                            if (validateYtDlpOptionsJson(jsonStr || '')) {
                                config.YtDlpOptionsJson = config.ytDlpOptionsJson = '{}';
                                didNormalizeJson = true;
                            }
                            if (didNormalizePath || didNormalizeJson) {
                                return ApiClient.updatePluginConfiguration(pluginId, config).then(function() {
                                    return { config: config, versionResponse: r, didNormalizePath: true, didNormalizeJson: true };
                                });
                            }
                            return { config: config, versionResponse: r, didNormalizePath: false, didNormalizeJson: false };
                        });
                    });
                }

                function validateYtDlpOptionsJson(value) {
                    if (!value || typeof value !== 'string') return null;
                    var s = value.trim();
                    if (s === '') return null;
                    try {
                        JSON.parse(s);
                        return null;
                    } catch (e) {
                        return e.message || 'Invalid JSON';
                    }
                }

                function showYtDlpJsonInlineError(msg) {
                    var el = document.getElementById('JellyTrailersYtDlpJsonError');
                    if (!el) return;
                    if (msg) {
                        el.textContent = msg;
                        el.style.display = 'block';
                    } else {
                        el.textContent = '';
                        el.style.display = 'none';
                    }
                }

                function isInvalidTrailerPath(path) {
                    if (!path || typeof path !== 'string') return false;
                    var p = path.trim();
                    return p.indexOf('..') !== -1 || /^[a-zA-Z]:[\\/]/.test(p) || p.indexOf('/') === 0;
                }

                page.addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    loadVersionAndConfig().then(function(result) {
                        var config = result.config;
                        var r = result.versionResponse;
                        var didNormalizePath = result.didNormalizePath;
                        var didNormalizeJson = result.didNormalizeJson;
                        var get = function(obj, p) { var q = obj[p]; if (q !== undefined) return q; var c = p.charAt(0).toLowerCase() + p.slice(1); return obj[c]; };
                        document.querySelector('#IncludeLibraryNames').value = get(config, 'IncludeLibraryNames') || '';
                        document.querySelector('#ExcludeLibraryNames').value = get(config, 'ExcludeLibraryNames') || '';
                        document.querySelector('#YtDlpPath').value = get(config, 'YtDlpPath') || '';
                        document.querySelector('#TrailerPath').value = get(config, 'TrailerPath') || 'trailer.mp4';
                        document.querySelector('#Quality').value = get(config, 'Quality') || '720p';
                        document.querySelector('#DelaySeconds').value = get(config, 'DelaySeconds') != null ? get(config, 'DelaySeconds') : 3;
                        document.querySelector('#RetryDelaySeconds').value = get(config, 'RetryDelaySeconds') != null ? get(config, 'RetryDelaySeconds') : 5;
                        document.querySelector('#MaxTrailersPerRun').value = get(config, 'MaxTrailersPerRun') != null ? get(config, 'MaxTrailersPerRun') : 50;
                        document.querySelector('#UseTmdbOmdbFallback').checked = get(config, 'UseTmdbOmdbFallback') !== false;
                        document.querySelector('#YtDlpOptionsJson').value = get(config, 'YtDlpOptionsJson') || '{}';
                        showYtDlpJsonInlineError(null);
                        Dashboard.hideLoadingMsg();
                        refreshYtDlpCheck();
                    }).catch(function() {
                        Dashboard.hideLoadingMsg();
                        document.querySelector('#JellyTrailersStatsContent').textContent = 'Could not load plugin ID or configuration.';
                    });
                    refreshStats();
                    if (statsPollInterval) clearInterval(statsPollInterval);
                    statsPollInterval = setInterval(refreshStats, 10000);
                });

                page.addEventListener('pagehide', function() {
                    if (statsPollInterval) {
                        clearInterval(statsPollInterval);
                        statsPollInterval = null;
                    }
                });

                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (!pluginId) return false;
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(pluginId).then(function(config) {
                        config.IncludeLibraryNames = (document.querySelector('#IncludeLibraryNames').value || '').trim();
                        config.ExcludeLibraryNames = (document.querySelector('#ExcludeLibraryNames').value || '').trim();
                        config.YtDlpPath = (document.querySelector('#YtDlpPath').value || '').replace(/^["']|["']$/g, '').trim();
                        var trailerPathInput = (document.querySelector('#TrailerPath').value || 'trailer.mp4').trim();
                        if (isInvalidTrailerPath(trailerPathInput)) {
                            config.TrailerPath = 'trailer.mp4';
                            config.TrailerPathCorrected = true;
                        } else {
                            config.TrailerPath = trailerPathInput || 'trailer.mp4';
                            config.TrailerPathCorrected = false;
                        }
                        config.Quality = document.querySelector('#Quality').value || '720p';
                        config.DelaySeconds = parseInt(document.querySelector('#DelaySeconds').value, 10) || 3;
                        config.RetryDelaySeconds = parseInt(document.querySelector('#RetryDelaySeconds').value, 10) || 5;
                        config.MaxTrailersPerRun = parseInt(document.querySelector('#MaxTrailersPerRun').value, 10) || 0;
                        config.UseTmdbOmdbFallback = document.querySelector('#UseTmdbOmdbFallback').checked;
                        config.YtDlpOptionsJson = document.querySelector('#YtDlpOptionsJson').value || '{}';
                        ApiClient.updatePluginConfiguration(pluginId, config).then(function(result) {
                            Dashboard.processPluginConfigurationUpdateResult(result);
                            if (config.TrailerPathCorrected) {
                                document.querySelector('#TrailerPath').value = 'trailer.mp4';
                            }
                            refreshYtDlpCheck();
                        });
                    });
                    return false;
                });

                document.querySelector('#BtnResetStats').addEventListener('click', function() {
                    if (!confirm('Reset all trailer statistics (downloaded/failed counts and run history)?')) return;
                    var contentEl = document.querySelector('#JellyTrailersStatsContent');
                    contentEl.textContent = 'Resetting…';
                    ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl('Plugins/JellyTrailers/Stats/Reset')
                    }).then(function() {
                        refreshStats();
                    }).catch(function(err) {
                        contentEl.textContent = 'Reset failed: ' + (err.message || err);
                    });
                });

                function parseYtDlpDownloadResponse(response) {
                    if (!response) return null;
                    if (typeof response.Success !== 'undefined') return response;
                    var raw = response.responseText || response.response || (typeof response === 'string' ? response : null);
                    if (raw && typeof raw === 'string') {
                        try { return JSON.parse(raw); } catch (e) { return null; }
                    }
                    return null;
                }

                document.querySelector('#BtnDownloadYtDlp').addEventListener('click', function() {
                    var btn = document.querySelector('#BtnDownloadYtDlp');
                    var statusEl = document.querySelector('#JellyTrailersYtDlpDownloadStatus');
                    btn.disabled = true;
                    statusEl.textContent = 'Downloading…';
                    ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl('Plugins/JellyTrailers/YtDlpDownload'),
                        dataType: 'json'
                    }).then(function(response) {
                        var r = parseYtDlpDownloadResponse(response);
                        if (!r) {
                            statusEl.textContent = 'Download failed. Could not read server response.';
                            return;
                        }
                        if (r.Success && r.Path) {
                            document.querySelector('#YtDlpPath').value = r.Path;
                            statusEl.textContent = 'Saving path…';
                            return ApiClient.getPluginConfiguration(pluginId).then(function(config) {
                                config.YtDlpPath = r.Path;
                                return ApiClient.updatePluginConfiguration(pluginId, config);
                            }).then(function() {
                                statusEl.textContent = r.Message || 'Downloaded and path saved.';
                                refreshYtDlpCheck();
                            }).catch(function(saveErr) {
                                statusEl.textContent = 'Downloaded. Save the settings below to use the new path.';
                                refreshYtDlpCheck();
                            });
                        } else if (r.Success) {
                            statusEl.textContent = r.Message || 'Downloaded.';
                            refreshYtDlpCheck();
                        } else {
                            statusEl.textContent = (r.Message && r.Message.trim()) ? r.Message : 'Download failed. Check Jellyfin server logs.';
                        }
                    }).catch(function(err) {
                        var msg = (err && err.message) ? err.message : String(err);
                        statusEl.textContent = 'Request failed: ' + (msg || 'no details. Check Jellyfin logs.');
                    }).finally(function() {
                        btn.disabled = false;
                    });
                });

                var ytDlpJsonInput = document.getElementById('YtDlpOptionsJson');
                if (ytDlpJsonInput) {
                    ytDlpJsonInput.addEventListener('blur', function() {
                        var err = validateYtDlpOptionsJson(this.value);
                        showYtDlpJsonInlineError(err);
                    });
                }

                document.querySelector('#BtnRemoveAllTrailers').addEventListener('click', function() {
                    if (!confirm('This will delete all trailer files in your movie and TV libraries (using the trailer filename setting above). Continue?')) {
                        return;
                    }
                    var statusEl = document.querySelector('#RemoveAllTrailersStatus');
                    statusEl.textContent = 'Starting task…';
                    ApiClient.getJSON(ApiClient.getUrl('ScheduledTasks')).then(function(tasks) {
                        var task = tasks.find(function(t) { return t.Key === 'JellyTrailersRemoveAll'; });
                        if (!task) {
                            statusEl.textContent = 'JellyTrailers remove-all task not found.';
                            return;
                        }
                        return ApiClient.ajax({
                            type: 'POST',
                            url: ApiClient.getUrl('ScheduledTasks/Running/' + task.Id)
                        }).then(function() {
                            statusEl.textContent = 'Task started. Check Dashboard → Scheduled Tasks for progress.';
                        }).catch(function(err) {
                            statusEl.textContent = 'Failed to start task: ' + (err.message || err);
                        });
                    }).catch(function(err) {
                        statusEl.textContent = 'Failed to load tasks: ' + (err.message || err);
                    });
                });
            })();
        </script>
    </div>
</body>
</html>
